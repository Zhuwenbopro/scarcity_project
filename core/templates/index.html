<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>任务管理极简UI</title>
    <meta name="viewport" content="width=1024">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', 'Helvetica', Arial, sans-serif;
            background: #fafbfc;
            color: #151515;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 210px;
            background: #fff;
            border-right: 1px solid #eee;
            padding: 38px 0 0 0;
            box-sizing: border-box;
            min-width: 170px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar li {
            padding: 13px 36px;
            cursor: pointer;
            font-size: 1.05em;
            color: #232323;
            border-left: 3px solid transparent;
            transition: background 0.2s;
        }

        .sidebar li.active, .sidebar li:hover {
            background: #f3f3f3;
            border-left: 3px solid #121212;
            color: #111;
        }

        .main {
            flex: 1;
            padding: 48px 44px 0 44px;
            position: relative;
            background: #fafbfc;
        }

        .headline {
            font-size: 2em;
            margin: 0 0 14px 0;
            font-weight: 600;
        }

        .subtle-bar {
            height: 7px;
            background: #ececec;
            border-radius: 5px;
            margin: 0 0 18px 0;
            width: 230px;
        }

        .section-title {
            margin: 32px 0 16px 0;
            font-size: 1.1em;
            font-weight: 500;
            letter-spacing: .05em;
        }

        table {
            border-collapse: collapse;
            background: #fff;
            width: 99%;
            min-width: 650px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        th, td {
            padding: 9px 9px;
            border-bottom: 1px solid #efefef;
            text-align: left;
            font-size: 1em;
        }

        th {
            color: #aaa;
            font-weight: 400;
        }

        tag {
            display: inline-block;
            background: #ffd497;
            color: #00796b;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 4px;
            font-size: 0.9em;
        }

        .priority-urgent {
            color: #d32f2f;
            font-weight: 600;
        }

        .priority-important {
            color: #ed6c02;
            font-weight: 500;
        }

        .energy-high {
            color: #00897b;
        }

        .energy-medium {
            color: #ffa000;
        }

        .energy-low {
            color: #666;
        }

        .focus-timer {
            position: absolute;
            right: 40px;
            top: 54px;
            width: 260px;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(10, 10, 10, 0.06);
            padding: 23px 25px 23px 25px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 3;
        }

        .focus-timer .title {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 7px;
            letter-spacing: .03em;
        }

        .focus-timer .timer {
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .focus-timer .meta {
            font-size: 0.96em;
            color: #636363;
            margin-bottom: 9px;
        }

        .focus-timer .btn-group {
            margin-top: 8px;
            display: flex;
            gap: 7px;
            width: 100%;
        }

        .focus-timer button {
            font-size: 0.97em;
            border: none;
            padding: 6px 16px;
            border-radius: 9px;
            background: #f5f5f5;
            color: #222;
            cursor: pointer;
            transition: background .17s;
        }

        .focus-timer button.primary {
            background: #121212;
            color: #fff;
        }

        .focus-timer button:hover {
            background: #ebebeb;
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .main {
                padding: 22px 6vw 0 6vw;
            }

            .focus-timer {
                position: static;
                width: 100%;
                margin-top: 30px;
            }
        }
    </style>
    <style>
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            background: rgba(0, 0, 0, .08);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-card {
            background: #fff;
            padding: 28px 36px 20px 36px;
            border-radius: 16px;
            min-width: 310px;
            box-shadow: 0 6px 32px rgba(0, 0, 0, 0.08);
        }

        .modal-card label {
            display: block;
            margin: 14px 0 3px 0;
            font-size: 0.99em;
            color: #383838;
        }

        .modal-card input, .modal-card textarea, .modal-card select {
            width: 100%;
            border: 1px solid #ececec;
            border-radius: 8px;
            padding: 7px 8px;
            font-size: 1em;
            background: #fafbfc;
            margin-bottom: 7px;
        }

        .modal-card textarea {
            resize: vertical;
            min-height: 60px;
        }

        .modal-card .form-row {
            display: flex;
            gap: 10px;
        }

        .modal-card .form-row > * {
            flex: 1;
        }

        .modal-card .actions {
            text-align: right;
            margin-top: 13px;
        }

        .modal-card button {
            font-size: 0.99em;
            padding: 5px 19px;
            border: none;
            border-radius: 8px;
            background: #efefef;
            margin-left: 6px;
            cursor: pointer;
        }

        .modal-card button.primary {
            background: #111;
            color: #fff;
        }
    </style>

</head>
<body>
<div class="container">
    <!-- 侧边栏 -->
    <nav class="sidebar">
        <ul id="menu-list">
            <li data-page="today" class="active">Today's Tasks</li>
            <li data-page="long_term_goal">长期目标</li>
            <li data-page="short_term_goal">短期目标</li>
            <li data-page="task">任务清单</li>
            <li data-page="work_log">Work Log</li>
            <li data-page="energy_log">Energy Log</li>
            <li data-page="settings">Settings</li>
        </ul>
    </nav>
    <main class="main">
        <!-- 今日任务页面 -->
        <div id="page-today" class="main-page"></div>
        <!-- 长期目标页面 -->
        <div id="page-long_term_goal" class="main-page" style="display:none"></div>
        <!-- 短期目标页面 -->
        <div id="page-short_term_goal" class="main-page" style="display:none"></div>
        <!-- 任务清单页面 -->
        <div id="page-task" class="main-page" style="display:none"></div>
        <!-- 其它页面... -->
    </main>

    <!-- 主内容区 -->
    <main class="main">
        <!-- 今日任务页面 -->
        <div id="page-today" class="main-page">
            <div class="headline" id="main-date"></div>
            <div style="margin-bottom:10px;color:#757575;font-size:1em;">可用工作时常</div>
            <div class="subtle-bar" style="width:220px;"></div>
            <div style="margin-top:12px; margin-bottom:8px; color:#757575; font-size:1em;">Energy</div>
            <div class="subtle-bar" style="width:140px;"></div>

            <div class="section-title">Today's To-Do List</div>
            <table>
                <thead>
                <tr>
                    <th>任务</th>
                    <th>优先级</th>
                    <th>预估耗时</th>
                    <th>能耗</th>
                    <th>标签</th>
                    <th>来源</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="job-list">
                <!-- JS填充 -->
                </tbody>
            </table>
            <hr/>
            <div class="section-title">Tasks List</div>
            <table>
                <thead>
                <tr>
                    <th>任务</th>
                    <th>优先级</th>
                    <th>起止时间</th>
                    <th>预估（已用）</th>
                    <th>标签</th>
                    <th>能耗</th>
                    <th>目标</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="task-list">
                <!-- JS填充 -->
                </tbody>
            </table>
        </div>
        <!-- 长期目标页面 -->
        <div id="page-long_term_goal" class="main-page" style="display:none"></div>
        <!-- 短期目标页面 -->
        <div id="page-short_term_goal" class="main-page" style="display:none"></div>
        <!-- 任务清单页面 -->
        <div id="page-task" class="main-page" style="display:none"></div>
        <!-- 其它页面... -->

        <!-- Focus Timer 浮动卡片 -->
        <div class="focus-timer" id="focus-timer">
            <div class="title" id="focus-title"></div>
            <div class="timer" id="focus-countdown">00:00</div>
            <div class="meta" id="focus-energy"></div>
            <div class="meta" id="focus-bandwidth"></div>
            <div class="btn-group">
                <button id="stop-btn" class="primary">结束</button>
            </div>
        </div>
    </main>
</div>

<script>
    function getCookie(name) {
        let val = null;
        if (document.cookie) {
            document.cookie.split(';').forEach(cookie => {
                const [k, v] = cookie.trim().split('=');
                if (k === name) val = decodeURIComponent(v);
            });
        }
        return val;
    }

    async function apiFetch(url, {method = 'GET', headers = {}, body = null} = {}) {
        let opts = {method, credentials: 'include', headers: {...headers}};
        if (body && typeof body === 'object' && !(body instanceof FormData)) {
            body = JSON.stringify(body);
            opts.headers['Content-Type'] = 'application/json';
        }
        if (method !== 'GET') {
            opts.headers['X-CSRFToken'] = getCookie('csrftoken');
        }
        if (body) opts.body = body;
        let res = await fetch(url, opts);
        // 自动报错（你可以优化为错误提示UI）
        if (!res.ok) {
            let err = '';
            try {
                err = await res.json();
            } catch {
            }
            throw err || new Error(`HTTP ${res.status}`);
        }
        // PATCH/DELETE有时返回空body，这里安全返回
        let txt = await res.text();
        try {
            return txt ? JSON.parse(txt) : {};
        } catch {
            return {};
        }
    }

    document.querySelectorAll('#menu-list li').forEach(li => {
        li.addEventListener('click', function () {
            document.querySelectorAll('#menu-list li').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
            const page = this.dataset.page;
            document.querySelectorAll('.main-page').forEach(div => div.style.display = 'none');
            document.getElementById('page-' + page).style.display = '';
            // 页面切换时自动刷新内容
            if (page === 'long_term_goal') fetchAndRenderLongTermGoals();
            else if (page === 'short_term_goal') fetchAndRenderShortTermGoals();
            else if (page === 'task') fetchAndRenderTasks();
            // ...其它页面同理
        });
    });

    function showForm({type, data = null, onSave}) {
        // 字段配置
        let fields = [];
        if (type === 'long') {
            fields = [
                {name: 'name', label: '长期目标描述', type: 'textarea'},
                {name: 'status', label: '状态', type: 'select', options: ['持续追求', '已归档']}
            ];
        } else if (type === 'short') {
            fields = [
                {name: 'name', label: '短期目标描述', type: 'textarea'},
                {
                    name: 'priority',
                    label: '优先级',
                    type: 'select',
                    options: ['重要且紧急', '重要不紧急', '紧急不重要', '不重要不紧急']
                },
                {
                    name: 'status',
                    label: '状态',
                    type: 'select',
                    options: ['未开始', '进行中', '已完成', '已推迟', '已放弃', '阻塞']
                },
                {name: 'target_date', label: '目标日期', type: 'date'},
                {name: 'estimated_time_days', label: '预估天数', type: 'number'},
            ];
        } else if (type === 'task') {
            fields = [
                {name: 'name', label: '任务名称', type: 'text'},
                {name: 'priority', label: '优先级(1-5, 1为最高)', type: 'number', min: 1, max: 5},
                {name: 'energy_level_estimate', label: '精力预估', type: 'select', options: ['高', '中', '低']},
                {name: 'tags', label: '标签（逗号分隔）', type: 'text'},
                {name: 'estimated_time_minutes', label: '预估耗时(分钟)', type: 'number'},
                {name: 'start_date', label: '开始日期', type: 'date'},
                {name: 'end_date', label: '截止日期', type: 'date'},
                {
                    name: 'short_term_goal_ref',
                    label: '关联短期目标',
                    type: 'select',
                    options: window.shortTermGoalOptions || []
                },
                {
                    name: 'long_term_goal_ref',
                    label: '关联长期目标',
                    type: 'select',
                    options: window.longTermGoalOptions || []
                },
            ];
        }
        // HTML生成
        let html = `<div class="modal-mask"><div class="modal-card"><div style="font-size:1.08em;margin-bottom:10px;">${data ? '编辑' : '新建'}${type === 'long' ? '长期目标' : type === 'short' ? '短期目标' : '任务'}</div>
        <form id="goal-form">${fields.map(f => {
            if (f.type === 'textarea') return `<label>${f.label}<textarea name="${f.name}" required></textarea></label>`;
            if (f.type === 'select') {
                let opts = (Array.isArray(f.options) ? f.options : []).map(opt => {
                    let v = typeof opt === 'object' ? opt.value : opt;
                    let txt = typeof opt === 'object' ? opt.label : opt;
                    return `<option value="${v}">${txt}</option>`;
                }).join('');
                return `<label>${f.label}<select name="${f.name}" ${f.options.length ? '' : 'disabled'}>${opts}</select></label>`;
            }
            return `<label>${f.label}<input name="${f.name}" type="${f.type}" ${f.min ? `min="${f.min}"` : ''} ${f.max ? `max="${f.max}"` : ''}></label>`;
        }).join('')}</form>
        <div class="actions">
            <button id="goal-cancel">取消</button>
            <button id="goal-ok" class="primary">保存</button>
        </div>
    </div></div>`;
        let modal = document.createElement('div');
        modal.innerHTML = html;
        document.body.appendChild(modal);

        // 填充默认值
        if (data) {
            let form = modal.querySelector('form');
            Object.keys(data).forEach(k => {
                if (form[k] !== undefined && data[k] != null) form[k].value = data[k];
            });
        }

        // 取消
        modal.querySelector('#goal-cancel').onclick = () => document.body.removeChild(modal);
        // 保存
        modal.querySelector('#goal-ok').onclick = () => {
            let form = modal.querySelector('form');
            let fd = new FormData(form);
            let obj = {};
            for (let [k, v] of fd.entries()) obj[k] = v;
            // 数字字段自动转型
            ['priority', 'estimated_time_days', 'estimated_time_minutes'].forEach(f => {
                if (obj[f] !== undefined && obj[f] !== '') obj[f] = Number(obj[f]);
            });
            // 空字符串转null
            Object.keys(obj).forEach(k => {
                if (obj[k] === '') obj[k] = null;
            });
            onSave(obj);
            document.body.removeChild(modal);
        };
    }

    async function refreshGoalOptions() {
        // 用于任务表单的下拉选择
        let short = await fetch('/api/short_term_goals/', {credentials: 'include'}).then(r => r.json());
        let long = await fetch('/api/long_term_goals/', {credentials: 'include'}).then(r => r.json());
        window.shortTermGoalOptions = [{label: '--无--', value: ''}, ...short.map(x => ({label: x.name, value: x.id}))];
        window.longTermGoalOptions = [{label: '--无--', value: ''}, ...long.map(x => ({label: x.name, value: x.id}))];
    }

    async function fetchAndRenderLongTermGoals() {
        let dom = document.getElementById('page-long_term_goal');
        let data = await apiFetch('/api/long_term_goals/');
        dom.innerHTML = `
        <div class="section-title" style="margin-top:0;">长期目标清单 <button id="add-long-goal-btn" style="margin-left:12px;">+ 新建</button></div>
        <table><thead><tr><th>描述</th><th>状态</th><th>创建时间</th><th>操作</th></tr></thead>
        <tbody>
        ${data.map(goal => `
          <tr>
            <td>${goal.name}</td>
            <td>${goal.status}</td>
            <td>${goal.created_at ? goal.created_at.substr(0, 10) : ''}</td>
            <td>
              <button class="edit-long-goal" data-id="${goal.id}">编辑</button>
              <button class="del-long-goal" data-id="${goal.id}">删除</button>
            </td>
          </tr>
        `).join('')}
        </tbody></table>
    `;
        dom.querySelector('#add-long-goal-btn').onclick = () => {
            showForm({
                type: 'long',
                onSave: async ({name, status}) => {
                    await apiFetch('/api/long_term_goals/', {method: 'POST', body: {name, status}});
                    fetchAndRenderLongTermGoals();
                }
            });
        };
        dom.querySelectorAll('.edit-long-goal').forEach(btn => {
            btn.onclick = () => {
                let goal = data.find(x => x.id == btn.dataset.id);
                showForm({
                    type: 'long',
                    data: goal,
                    onSave: async ({name, status}) => {
                        await apiFetch(`/api/long_term_goals/${goal.id}/`, {method: 'PATCH', body: {name, status}});
                        fetchAndRenderLongTermGoals();
                    }
                });
            };
        });
        dom.querySelectorAll('.del-long-goal').forEach(btn => {
            btn.onclick = async () => {
                if (confirm('确定删除？')) {
                    await apiFetch(`/api/long_term_goals/${btn.dataset.id}/`, {method: 'DELETE'});
                    fetchAndRenderLongTermGoals();
                }
            }
        });
    }

    async function fetchAndRenderShortTermGoals() {
        let dom = document.getElementById('page-short_term_goal');
        let data = await apiFetch('/api/short_term_goals/');
        dom.innerHTML = `
        <div class="section-title" style="margin-top:0;">短期目标清单 <button id="add-short-goal-btn" style="margin-left:12px;">+ 新建</button></div>
        <table><thead><tr><th>描述</th><th>优先级</th><th>状态</th><th>目标日期</th><th>预估天数</th><th>操作</th></tr></thead>
        <tbody>
        ${data.map(goal => `
          <tr>
            <td>${goal.name}</td>
            <td>${goal.priority || ''}</td>
            <td>${goal.status || ''}</td>
            <td>${goal.target_date || ''}</td>
            <td>${goal.estimated_time_days || ''}</td>
            <td>
              <button class="edit-short-goal" data-id="${goal.id}">编辑</button>
              <button class="del-short-goal" data-id="${goal.id}">删除</button>
            </td>
          </tr>
        `).join('')}
        </tbody></table>
    `;
        dom.querySelector('#add-short-goal-btn').onclick = () => {
            showForm({
                type: 'short',
                onSave: async (obj) => {
                    await apiFetch('/api/short_term_goals/', {method:'POST', body:JSON.stringify(obj)});
                    fetchAndRenderShortTermGoals();
                    await refreshGoalOptions(); // 刷新任务下拉
                }
            });
        };
        dom.querySelectorAll('.edit-short-goal').forEach(btn => {
            btn.onclick = () => {
                let goal = data.find(x => x.id == btn.dataset.id);
                showForm({
                    type: 'short',
                    data: goal,
                    onSave: async (obj) => {
                        await apiFetch(`/api/short_term_goals/${goal.id}/`, {method:'PATCH', body:JSON.stringify(obj)});
                        fetchAndRenderShortTermGoals();
                        await refreshGoalOptions();
                    }
                });
            };
        });
        dom.querySelectorAll('.del-short-goal').forEach(btn => {
            btn.onclick = async () => {
                if (confirm('确定删除？')) {
                    await apiFetch(`/api/short_term_goals/${btn.dataset.id}/`, {method:'DELETE'});
                    fetchAndRenderShortTermGoals();
                    await refreshGoalOptions();
                }
            }
        });
    }

    async function fetchAndRenderTasks() {
        await refreshGoalOptions();
        let dom = document.getElementById('page-task');
        let data = await apiFetch('/api/tasks/');
        dom.innerHTML = `
        <div class="section-title" style="margin-top:0;">任务清单 <button id="add-task-btn" style="margin-left:12px;">+ 新建</button></div>
        <table><thead><tr>
          <th>名称</th><th>优先级</th><th>精力</th><th>标签</th>
          <th>预估</th><th>开始</th><th>截止</th>
          <th>短期目标</th><th>长期目标</th>
          <th>操作</th>
        </tr></thead>
        <tbody>
        ${data.map(task => `
          <tr>
            <td>${task.name}</td>
            <td>${task.priority}</td>
            <td>${task.energy_level_estimate || ''}</td>
            <td>${task.tags || ''}</td>
            <td>${task.estimated_time_minutes || ''}</td>
            <td>${task.start_date || ''}</td>
            <td>${task.end_date || ''}</td>
            <td>${task.short_term_goal_ref ? (task.short_term_goal_name || task.short_term_goal_ref) : ''}</td>
            <td>${task.long_term_goal_ref ? (task.long_term_goal_name || task.long_term_goal_ref) : ''}</td>
            <td>
              <button class="edit-task" data-id="${task.id}">编辑</button>
              <button class="del-task" data-id="${task.id}">删除</button>
            </td>
          </tr>
        `).join('')}
        </tbody></table>
    `;
        dom.querySelector('#add-task-btn').onclick = () => {
            showForm({
                type: 'task',
                onSave: async (obj) => {
                    // 转为int id
                    if (obj.short_term_goal_ref) obj.short_term_goal_ref = Number(obj.short_term_goal_ref) || null;
                    if (obj.long_term_goal_ref) obj.long_term_goal_ref = Number(obj.long_term_goal_ref) || null;
                    await apiFetch('/api/tasks/', {method:'POST', body:JSON.stringify(obj)});
                    fetchAndRenderTasks();
                }
            });
        };
        dom.querySelectorAll('.edit-task').forEach(btn => {
            btn.onclick = () => {
                let task = data.find(x => x.id == btn.dataset.id);
                showForm({
                    type: 'task',
                    data: task,
                    onSave: async (obj) => {
                        if (obj.short_term_goal_ref) obj.short_term_goal_ref = Number(obj.short_term_goal_ref) || null;
                        if (obj.long_term_goal_ref) obj.long_term_goal_ref = Number(obj.long_term_goal_ref) || null;
                        await apiFetch(`/api/tasks/${task.id}/`, {method:'PATCH', body:JSON.stringify(obj)});
                        fetchAndRenderTasks();
                    }
                });
            };
        });
        dom.querySelectorAll('.del-task').forEach(btn => {
            btn.onclick = async () => {
                if (confirm('确定删除？')) {
                    await apiFetch(`/api/tasks/${btn.dataset.id}/`, {method:'DELETE'});
                    fetchAndRenderTasks();
                }
            }
        });
    }


    window.addEventListener('DOMContentLoaded', async () => {
        await refreshGoalOptions();
        // 你原本的 fetchTodayTasks 等不变
    });

    // 示例数据
    let todayTasksList = {};

    // 渲染日期
    function renderDate() {
        const now = new Date();
        const s = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0');
        document.getElementById('main-date').innerText = s;
    }

    renderDate();

    // Focus Timer（示例倒计时功能）
    let timerSec = 0; // 25分钟
    let intervalId = null;
    let startTime = null;
    let currentTask = null;

    function pad(n) {
        return String(n).padStart(2, '0');
    }

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const ss = s % 60;
        return pad(m) + ':' + pad(ss);
    }

    function updateTimer() {
        const min = Math.floor(timerSec / 60);
        const sec = timerSec % 60;
        document.getElementById('focus-countdown').innerText =
            pad(min) + ':' + pad(sec);
    }

    function initTimer() {
        updateTimer();
        if (intervalId === null) {
            intervalId = setInterval(() => {
                timerSec = Math.floor(((new Date()).getTime() - startTime) / 1000);
                updateTimer();
            }, 1000);
        }
    }

    function restartTimer() {
        timerSec = 0;
        updateTimer();
    }

    function setFocusTimer(task) {
        startTime = (new Date()).getTime();
        currentTask = task;
        restartTimer();


        // “停止” 按钮
        document.getElementById('stop-btn').onclick = () => {
            if (currentTask) {
                updateResource(
                    '/api/tasks', currentTask.id,
                    {actual_time_minutes: currentTask.actual_time_minutes + Math.floor(timerSec / 60)}
                );
            }
            setFocusTimer(null);  // 切到休息
        };

        if (task === null) {
            document.getElementById('focus-title').innerText = "休息中";
            document.getElementById('focus-energy').innerText = "";
            document.getElementById('focus-bandwidth').innerText = "";
        } else {
            document.getElementById('focus-title').innerText = task.name;
            document.getElementById('focus-energy').innerText = 'Energy: ' + task.energy_level_estimate;
            document.getElementById('focus-bandwidth').innerText = 'Bandwidth: ' + task.tags;
        }
    }

    function renderTasksList(tasks) {
        const tbody = document.getElementById('task-list');
        tbody.innerHTML = '';

        tasks.forEach(task => {
            // 计算 “起止时间” 显示
            let timeRange = '--';
            if (task.start_date && task.end_date) {
                const start = new Date(task.start_date);
                const end = new Date(task.end_date);
                const fmt = d => `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
                timeRange = `${fmt(start)} - ${fmt(end)}`;
            }
            const estimated = task.estimated_time_minutes + ` (${task.actual_time_minutes})`;
            let goalName = task.short_term_goal_name || task.long_term_goal_name || '--';
            goalName = goalName.split(' (')[0];

            const tagsHtml = task.tags
                ? task.tags.split(',').map(t => `<tag>${t.trim()}</tag>`).join(' ')
                : '--';


            // 优先级着色
            let prioClass = '';
            if (task.priority === 5) prioClass = 'priority-urgent';
            else if (task.priority > 2) prioClass = 'priority-important';

            // 精力着色
            let energyClass = '';
            if (task.energy_level_estimate === '高') energyClass = 'energy-high';
            else if (task.energy_level_estimate === '中') energyClass = 'energy-medium';
            else energyClass = 'energy-low';

            // 每行 HTML
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${task.name}</td>
                <td class="${prioClass}">${task.priority}</td>
                <td>${timeRange}</td>
                <td>${estimated} min</td>
                <td>${tagsHtml}</td>
                <td class="${energyClass}">${task.energy_level_estimate || '--'}</td>
                <td>${goalName}</td>
                <td><button class="add-btn" data-task-id="${task.id}">添加</button></td>
              `;
            tbody.appendChild(tr);
        });

        // —— 给所有“添加”按钮挂点击事件
        tbody.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = Number(btn.dataset.taskId);
                const entry = await addTodayTask(id);
            });
        });

    }

    function renderTodayTasksList(todayTasks) {
        const tbody = document.getElementById('job-list');
        tbody.innerHTML = '';
        todayTasksList = {};

        todayTasks.forEach(t => {
            let task = t.task_details;
            todayTasksList[task.id] = task;
            // 优先级着色
            let prioClass = '';
            if (task.priority === 5) prioClass = 'priority-urgent';
            else if (task.priority > 2) prioClass = 'priority-important';

            // 精力着色
            let energyClass = '';
            if (task.energy_level_estimate === '高') energyClass = 'energy-high';
            else if (task.energy_level_estimate === '中') energyClass = 'energy-medium';
            else energyClass = 'energy-low';

            // 标签渲染
            const tagsHtml = task.tags
                ? task.tags.split(',').map(t => `<tag>${t.trim()}</tag>`).join(' ')
                : '--';

            // 来源：优先短期目标，否则长期目标
            let source = task.short_term_goal_name || task.long_term_goal_name || '--';
            // 去掉括号及内部
            source = source.split(' (')[0];

            // 预估耗时
            const est = task.estimated_time_minutes != null
                ? `${task.estimated_time_minutes}min`
                : '--';

            // 组装行
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${task.name}</td>
              <td class="${prioClass}">${task.priority}</td>
              <td>${est}</td>
              <td class="${energyClass}">${task.energy_level_estimate || '--'}</td>
              <td>${tagsHtml}</td>
              <td>${source}</td>
              <td><button class="start-btn" data-id="${task.id}">开始</button> <button class="remove-btn" data-id="${t.id}">移除</button></td>
            `;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.dataset.id;
                const csrftoken = getCookie('csrftoken');
                try {
                    // 调用后端删除接口（假设 DELETE /api/today_tasks/{id}/）
                    const res = await fetch(`/api/today_tasks/${id}/`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    // 删除成功后，从页面上移除这行
                    btn.closest('tr').remove();
                } catch (err) {
                    console.error('移除今日任务失败：', err);
                }
            });
        });

        tbody.querySelectorAll('.start-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('stop-btn').click();
                const id = btn.dataset.id;
                setFocusTimer(todayTasksList[id]);
            });
        });

    }

    async function addTodayTask(taskId, date) {
        try {
            const csrftoken = getCookie('csrftoken');
            const today = new Date().toISOString().slice(0, 10);
            const payload = {task: taskId, date: today};
            if (date) payload.date = date;  // 如果你的 TodayTaskSerializer 接受 date 字段

            const res = await fetch('/api/today_tasks/', {
                method: 'POST',
                credentials: 'include',               // 如果使用 SessionAuthentication
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                const errData = await res.json().catch(() => null);
                throw new Error(`HTTP ${res.status} ${errData ? JSON.stringify(errData) : ''}`);
            }

            const newEntry = await res.json();
            console.log('添加今日任务成功：', newEntry);

            await fetchTodayTasks();

            return newEntry;
        } catch (err) {
            console.error('添加今日任务失败：', err);
            // 你可以在页面上弹个提示
            // alert('添加失败：' + err.message);
        }
    }

    async function fetchTasks() {
        try {
            const res = await fetch('/api/tasks/', {
                credentials: 'include',   // 如果你用的是 SessionAuthentication
                headers: {'Accept': 'application/json'}
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            renderTasksList(data);
        } catch (err) {
            console.error('拉取 tasks 失败：', err);
        }
    }

    async function fetchTodayTasks() {
        try {
            const res = await fetch('/api/today_tasks/', {
                credentials: 'include',   // 如果你用的是 SessionAuthentication
                headers: {'Accept': 'application/json'}
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            renderTodayTasksList(data);
        } catch (err) {
            console.error('拉取 today_tasks 失败：', err);
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        fetchTasks();
        fetchTodayTasks();

        initTimer();
        setFocusTimer(null);
    });

    async function updateResource(baseUrl, id, updates, method = 'PATCH') {
        // 从 Cookie 中读取 CSRF token（Django 默认名为 csrftoken）
        function getCookie(name) {
            const cookies = document.cookie.split(';').map(c => c.trim());
            for (let c of cookies) {
                const [key, val] = c.split('=');
                if (key === name) return decodeURIComponent(val);
            }
            return null;
        }

        const url = `${baseUrl}/${id}/`;
        const csrftoken = getCookie('csrftoken');

        try {
            const res = await fetch(url, {
                method,
                credentials: 'include',    // 带上 Session Cookie
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(updates),
            });

            const data = await res.json();
            if (!res.ok) {
                console.error(`更新资源 ${url} 失败：`, data);
                return null;
            }
            console.log(`更新资源 ${url} 成功：`, data);
            return data;

        } catch (err) {
            console.error(`网络或解析错误 (${method} ${url})：`, err);
            return null;
        }
    }
</script>
</body>
</html>
